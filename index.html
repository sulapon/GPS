<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>DSM å‰–é¢åˆ†æ - GitHub é›²ç«¯ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/geotiff"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 1100px; margin: auto; padding: 20px; background: #f0f2f5; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; }
        button { padding: 12px 25px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        #log { background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 6px; font-family: 'Consolas', monospace; font-size: 13px; margin-top: 15px; white-space: pre-wrap; line-height: 1.5; }
        .loading { color: #ff9f43; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h2>â›°ï¸ DSM å‰–é¢åˆ†æ (GitHub é›²ç«¯ç‰ˆ)</h2>
    <p style="color: #666;">ç›®å‰è®€å–ç›®æ¨™ï¼š<span style="color:#007bff; font-family:monospace;">taiwan_dsm_wgs84_cog.tif</span></p>
    
    <div class="input-group">
        <div><label>A é» (Lat, Lon)</label><input type="text" id="posA" value="25.214458, 121.563209"></div>
        <div><label>B é» (Lat, Lon)</label><input type="text" id="posB" value="24.499911, 121.087641"></div>
        <button onclick="startAnalysis()">é–‹å§‹åˆ†æå‰–é¢</button>
    </div>

    <div id="log">æº–å‚™å°±ç·’ï¼Œè«‹é»æ“Šåˆ†ææŒ‰éˆ•...</div>
</div>

<div style="height:500px; margin-top:20px; background:white; padding:20px; border-radius:12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
    <canvas id="profileChart"></canvas>
</div>

<script>
async function startAnalysis() {
    const log = document.getElementById('log');
    const pA = document.getElementById('posA').value.split(',').map(v => parseFloat(v.trim()));
    const pB = document.getElementById('posB').value.split(',').map(v => parseFloat(v.trim()));
    const tifUrl = "taiwan_dsm_wgs84_cog.tif"; // ç¢ºä¿æ­¤æª”æ¡ˆèˆ‡ HTML åœ¨åŒä¸€å±¤ç›®éŒ„

    log.innerHTML = `<span class="loading">â³ æ­£åœ¨å¾ä¼ºæœå™¨ä¸²æµè®€å– COG åœ–è³‡...</span>\n`;

    try {
        // å¾ URL è®€å–ï¼ŒGeoTIFF.js æœƒè‡ªå‹•ç™¼é€ Range Requests
        const tiff = await GeoTIFF.fromUrl(tifUrl);
        const image = await tiff.getImage();
        const bbox = image.getBoundingBox(); 
        const [w, h] = [image.getWidth(), image.getHeight()];

        log.innerHTML += `ğŸ› ï¸ å½±åƒå°æ¥æˆåŠŸï¼\n`;
        log.innerHTML += `ç¯„åœï¼šLon(${bbox[0].toFixed(4)}~${bbox[2].toFixed(4)}), Lat(${bbox[1].toFixed(4)}~${bbox[3].toFixed(4)})\n`;

        const samples = 400;
        let terrain = [];

        for (let i = 0; i <= samples; i++) {
            const r = i / samples;
            const lat = pA[0] + (pB[0] - pA[0]) * r;
            const lon = pA[1] + (pB[1] - pA[1]) * r;

            let x = ((lon - bbox[0]) / (bbox[2] - bbox[0])) * w;
            let y = ((bbox[3] - lat) / (bbox[3] - bbox[1])) * h;

            // é‚Šç•Œå®‰å…¨ä¿®æ­£
            const safeX = Math.max(0, Math.min(w - 1, Math.floor(x)));
            const safeY = Math.max(0, Math.min(h - 1, Math.floor(y)));

            // åƒ…æŠ“å–è©²åƒç´ çš„æ•¸æ“šï¼ŒCOG æ•ˆç‡æ¥µé«˜
            const raster = await image.readRasters({ window: [safeX, safeY, safeX + 1, safeY + 1] });
            let val = raster[0][0];

            if (i === samples) {
                log.innerHTML += `âœ… B é»æµ·æ‹”ï¼š${val.toFixed(1)} m\n`;
            }

            terrain.push(val > -1000 ? val : 0);
        }

        renderChart(terrain);
        log.innerHTML += `âœ¨ å‰–é¢åœ–ç”Ÿæˆå®Œç•¢ã€‚`;
    } catch (err) {
        log.innerHTML = `<span style="color:red;">âŒ è®€å–å¤±æ•—ï¼š${err.message}</span>\næç¤ºï¼šè«‹ç¢ºä¿æª”æ¡ˆåç¨±æ­£ç¢ºä¸”å·²ä¸Šå‚³è‡³ GitHubã€‚`;
    }
}

function renderChart(terrain) {
    const ctx = document.getElementById('profileChart').getContext('2d');
    if (window.myChart) window.myChart.destroy();

    const startH = terrain[0] + 3;
    const endH = terrain[terrain.length - 1] + 3;
    const los = terrain.map((_, i) => startH + (endH - startH) * (i / (terrain.length - 1)));

    window.myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: terrain.map(() => ""),
            datasets: [
                { label: '3m è¦–è· (LoS)', data: los, borderColor: '#ff9f43', borderWidth: 2, pointRadius: 0, fill: false },
                { label: 'åœ°å½¢å‰–é¢', data: terrain, backgroundColor: 'rgba(52, 73, 94, 0.6)', borderColor: '#2c3e50', fill: true, pointRadius: 0 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: false } }
        }
    });
}
</script>
</body>
</html>