<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>DSM é€šè¨Šå‰–é¢åˆ†æ - GitHub ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/geotiff"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 1100px; margin: auto; padding: 20px; background: #f0f2f5; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .input-group { display: grid; grid-template-columns: 1fr 1fr 1fr 100px; gap: 10px; margin-bottom: 15px; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { padding: 10px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        #log { background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 13px; margin-top: 15px; white-space: pre-wrap; height: 100px; overflow-y: auto; }
        .chart-container { height: 500px; margin-top: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ“¡ é€šè¨Šå®‰å…¨è·é›¢åˆ†æ (å«è²»æ¶…çˆ¾å€)</h2>
    <p style="color: 666; font-size: 14px;">è®€å–ç›®æ¨™ï¼š<span style="color:#007bff;">taiwan_dsm_wgs84_cog.tif</span> (è«‹ç¢ºä¿æª”æ¡ˆåœ¨åŒè³‡æ–™å¤¾)</p>
    
    <div class="input-group">
        <div><label>A é» (Lat, Lon)</label><input type="text" id="posA" value="25.214458, 121.563209"></div>
        <div><label>B é» (Lat, Lon)</label><input type="text" id="posB" value="24.499911, 121.087641"></div>
        <div><label>é »ç‡ (MHz)</label><input type="number" id="freq" value="2400"></div>
        <button onclick="startAnalysis()" style="margin-top: 20px;">åŸ·è¡Œ</button>
    </div>

    <div id="log">ç­‰å¾…åˆ†æ...</div>
</div>

<div class="chart-container">
    <canvas id="profileChart"></canvas>
</div>

<script>
async function startAnalysis() {
    const log = document.getElementById('log');
    const pA = document.getElementById('posA').value.split(',').map(v => parseFloat(v.trim()));
    const pB = document.getElementById('posB').value.split(',').map(v => parseFloat(v.trim()));
    const freq = parseFloat(document.getElementById('freq').value);
    
    // é€™è£¡ç›´æ¥å¡«å¯«ç›¸å°è·¯å¾‘ï¼Œåªè¦åœ¨ GitHub åŒè³‡æ–™å¤¾å³å¯
    const tifUrl = "taiwan_dsm_wgs84_cog.tif"; 

    log.innerHTML = `â³ æ­£åœ¨é€£æ¥é›²ç«¯ COG æ•¸æ“šæº...\n`;

    try {
        // ä½¿ç”¨ fromUrl è®€å– GitHub ä¸Šçš„è³‡æ–™
        const tiff = await GeoTIFF.fromUrl(tifUrl);
        const image = await tiff.getImage();
        const bbox = image.getBoundingBox(); 
        const [w, h] = [image.getWidth(), image.getHeight()];

        log.innerHTML += `âœ… é€£æ¥æˆåŠŸï¼ç¯„åœï¼šLon(${bbox[0].toFixed(3)}~${bbox[2].toFixed(3)})\n`;

        const samples = 300;
        let terrain = [], labels = [], fresnelLower = [], los = [];
        
        // ç°¡æ˜“è·é›¢è¨ˆç®— (ç”¨æ–¼è²»æ¶…çˆ¾å€)
        const distKM = Math.sqrt(Math.pow(pA[0]-pB[0], 2) + Math.pow(pA[1]-pB[1], 2)) * 111; 

        for (let i = 0; i <= samples; i++) {
            const r = i / samples;
            const lat = pA[0] + (pB[0] - pA[0]) * r;
            const lon = pA[1] + (pB[1] - pA[1]) * r;

            // ä½ çš„å°ä½é‚è¼¯ï¼ˆå·²ç¢ºèªè§£æ±ºåç§»å•é¡Œï¼‰
            const x = Math.max(0, Math.min(w - 1, ((lon - bbox[0]) / (bbox[2] - bbox[0])) * w));
            const y = Math.max(0, Math.min(h - 1, ((bbox[3] - lat) / (bbox[3] - bbox[1])) * h));

            const raster = await image.readRasters({ window: [Math.floor(x), Math.floor(y), Math.floor(x) + 1, Math.floor(y) + 1] });
            const val = raster[0][0] > -1000 ? raster[0][0] : 0;

            // è²»æ¶…çˆ¾åŠå¾‘è¨ˆç®— (F1 = 17.32 * sqrt((d1*d2)/(f*D)))
            const d1 = (distKM * r);
            const d2 = distKM - d1;
            const f1 = 17.32 * Math.sqrt((d1 * d2) / ((freq / 1000) * distKM));

            terrain.push(val);
            labels.push(d1.toFixed(1));
            fresnelLower.push(f1); // å­˜å…¥åŠå¾‘å¾…å¾ŒçºŒè™•ç†
        }

        // å»ºç«‹è¦–è·ç·š (å‡è¨­å¤©ç·šå„æ¶é«˜ 5m)
        const startH = terrain[0] + 5;
        const endH = terrain[samples] + 5;
        for (let i = 0; i <= samples; i++) {
            const r = i / samples;
            const lineVal = startH + (endH - startH) * r;
            los.push(lineVal);
            fresnelLower[i] = lineVal - (fresnelLower[i] * 0.6); // 60% è²»æ¶…çˆ¾å€å®‰å…¨ç·š
        }

        renderChart(labels, terrain, los, fresnelLower);
        log.innerHTML += `âœ¨ åˆ†æå®Œæˆã€‚ç¸½é•·åº¦ç´„ ${distKM.toFixed(2)} km`;

    } catch (err) {
        log.innerHTML += `âŒ è®€å–å¤±æ•—ï¼š${err.message}\næç¤ºï¼šè«‹ç¢ºèªæ˜¯å¦å·²é–‹å•Ÿ GitHub Pagesã€‚`;
    }
}

function renderChart(labels, terrain, los, fresnel) {
    const ctx = document.getElementById('profileChart').getContext('2d');
    if (window.myChart) window.myChart.destroy();

    window.myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                { label: '60% è²»æ¶…çˆ¾å®‰å…¨ç·š', data: fresnel, borderColor: '#e74c3c', borderDash: [5, 5], borderWidth: 1, pointRadius: 0, fill: false },
                { label: 'è¦–è· (LoS)', data: los, borderColor: '#f1c40f', borderWidth: 2, pointRadius: 0, fill: false },
                { label: 'åœ°å½¢å‰–é¢', data: terrain, backgroundColor: 'rgba(52, 73, 94, 0.6)', borderColor: '#2c3e50', fill: true, pointRadius: 0 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: false }, x: { ticks: { maxTicksLimit: 10 } } }
        }
    });
}
</script>
</body>
</html>