<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>GPS é€šè¨Šåˆ†æè¨ºæ–·å„€</title>
    <script src="https://cdn.jsdelivr.net/npm/geotiff"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f4f4f9; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        #log { background: #222; color: #0f0; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; height: 150px; overflow-y: auto; margin: 15px 0; }
        .controls { display: grid; grid-template-columns: 1fr 1fr 120px; gap: 10px; margin-bottom: 20px; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        button { background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .error { color: #ff4757; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“¡ å®‰å…¨é€šè¨Šè·é›¢åˆ†æ (Fresnel Radius)</h2>
    <div class="controls">
        <input type="text" id="posA" value="25.214458, 121.563209" placeholder="Aé» (Lat, Lon)">
        <input type="text" id="posB" value="24.499911, 121.087641" placeholder="Bé» (Lat, Lon)">
        <button onclick="runDiagnostic()">åŸ·è¡Œåˆ†æ</button>
    </div>
    
    <div>é »ç‡: <input type="number" id="freq" value="2400" style="width:80px"> MHz | å¤©ç·šé«˜: <input type="number" id="antH" value="5" style="width:50px"> m</div>

    <div id="log">æº–å‚™å°±ç·’ã€‚é»æ“Šã€ŒåŸ·è¡Œåˆ†æã€é–‹å§‹è¨ºæ–·...</div>
    
    <div style="height:400px;">
        <canvas id="mainChart"></canvas>
    </div>
</div>

<script>
async function runDiagnostic() {
    const log = document.getElementById('log');
    const filename = "taiwan_dsm_wgs84_cog.tif";
    log.innerHTML = `[${new Date().toLocaleTimeString()}] é–‹å§‹è¨ºæ–·...\n`;

    try {
        // --- 1. æª”æ¡ˆå­˜åœ¨æ€§èˆ‡å¤§å°æª¢æŸ¥ ---
        log.innerHTML += `ğŸ“¡ å˜—è©¦è®€å–æª”æ¡ˆ: ${filename}...\n`;
        const response = await fetch(filename, { method: 'GET', headers: { 'Range': 'bytes=0-1024' } });
        
        if (!response.ok) {
            throw new Error(`æ‰¾ä¸åˆ°æª”æ¡ˆ (HTTP ${response.status})ã€‚è«‹ç¢ºèªæª”æ¡ˆæ˜¯å¦åœ¨ Repo æ ¹ç›®éŒ„ä¸”æª”åæ­£ç¢ºã€‚`);
        }

        const contentLength = response.headers.get('content-range') || "æœªçŸ¥";
        log.innerHTML += `âœ… ä¼ºæœå™¨éŸ¿æ‡‰æ­£å¸¸ã€‚æ•¸æ“šç‰‡æ®µå·²ç²å–ã€‚\n`;

        // --- 2. LFS æª¢æŸ¥ ---
        const blob = await response.blob();
        const text = await blob.text();
        if (text.includes("version https://git-lfs.github.com")) {
            log.innerHTML += `<span class="error">âŒ åµæ¸¬åˆ° Git LFS æŒ‡é‡ï¼</span>\n`;
            log.innerHTML += `åŸå› ï¼šGitHub Pages ä¸æ”¯æ´ç›´æ¥è®€å– LFS åŸå§‹æª”ã€‚\n`;
            log.innerHTML += `è§£æ±ºï¼šè«‹åœ¨æœ¬åœ°åŸ·è¡Œ 'git lfs untrack "${filename}"'ï¼Œç„¶å¾Œé‡æ–°ä¸Šå‚³ç‚ºæ™®é€šæª”æ¡ˆï¼ˆéœ€å°æ–¼ 100MBï¼‰ï¼Œæˆ–å°‡ TIF æ”¾åœ¨å…¶ä»–æ”¯æ´ç›´é€£çš„ç©ºé–“ã€‚\n`;
            return;
        }

        // --- 3. é–‹å§‹ GeoTIFF è™•ç† ---
        const tiff = await GeoTIFF.fromUrl(filename);
        const image = await tiff.getImage();
        const bbox = image.getBoundingBox();
        const [w, h] = [image.getWidth(), image.getHeight()];

        log.innerHTML += `âœ… GeoTIFF è§£ææˆåŠŸï¼è§£æåº¦: ${w}x${h}\n`;

        // --- 4. è¨ˆç®—å‰–é¢èˆ‡è²»æ¶…çˆ¾å€ ---
        const pA = document.getElementById('posA').value.split(',').map(v => parseFloat(v.trim()));
        const pB = document.getElementById('posB').value.split(',').map(v => parseFloat(v.trim()));
        const freq = parseFloat(document.getElementById('freq').value);
        const antH = parseFloat(document.getElementById('antH').value);
        
        const samples = 200;
        let terrain = [], los = [], fresnel = [], labels = [];
        
        // ç°¡å–®è·é›¢ä¼°ç®— (km)
        const distKM = Math.sqrt(Math.pow(pA[0]-pB[0],2) + Math.pow(pA[1]-pB[1],2)) * 111;

        for (let i = 0; i <= samples; i++) {
            const r = i / samples;
            const lat = pA[0] + (pB[0] - pA[0]) * r;
            const lon = pA[1] + (pB[1] - pA[1]) * r;

            const x = Math.max(0, Math.min(w - 1, ((lon - bbox[0]) / (bbox[2] - bbox[0])) * w));
            const y = Math.max(0, Math.min(h - 1, ((bbox[3] - lat) / (bbox[3] - bbox[1])) * h));

            const raster = await image.readRasters({ window: [Math.floor(x), Math.floor(y), Math.floor(x) + 1, Math.floor(y) + 1] });
            const elev = raster[0][0] > -500 ? raster[0][0] : 0;
            
            // åœ°çƒæ›²ç‡ä¿®æ­£ (h = d1*d2 / 12.74)
            const d1 = distKM * r;
            const d2 = distKM * (1 - r);
            const drop = (d1 * d2) / 12.742; // å…¬é‡Œè½‰å…¬å°ºçš„ç°¡åŒ–å…¬å¼
            
            // è²»æ¶…çˆ¾åŠå¾‘ F1 = 17.32 * sqrt( (d1*d2) / (f*D) )
            const f1 = 17.32 * Math.sqrt((d1 * d2) / ((freq / 1000) * distKM));

            terrain.push(elev + drop);
            labels.push(d1.toFixed(1));
            fresnel.push(f1);
        }

        // è¨ˆç®—è¦–è·ç·šèˆ‡å®‰å…¨å€
        const startH = terrain[0] + antH;
        const endH = terrain[samples] + antH;
        const finalFresnel = terrain.map((t, i) => {
            const r = i / samples;
            const line = startH + (endH - startH) * r;
            los.push(line);
            return line - (fresnel[i] * 0.6); // 60% è²»æ¶…çˆ¾å€
        });

        draw(labels, terrain, los, finalFresnel);
        log.innerHTML += `âœ¨ åˆ†æå®Œæˆï¼ç¸½è·¯å¾‘ï¼š${distKM.toFixed(2)} km\n`;

    } catch (err) {
        log.innerHTML += `<span class="error">âŒ éŒ¯èª¤ï¼š${err.message}</span>\n`;
    }
}

function draw(labels, terrain, los, fresnel) {
    const ctx = document.getElementById('mainChart').getContext('2d');
    if (window.myChart) window.myChart.destroy();
    window.myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                { label: 'è¦–è· (LoS)', data: los, borderColor: '#f1c40f', pointRadius: 0, fill: false },
                { label: '60% è²»æ¶…çˆ¾å®‰å…¨ç·š', data: fresnel, borderColor: '#e74c3c', borderDash: [5,5], pointRadius: 0, fill: false },
                { label: 'ä¿®æ­£åœ°å½¢ (å«æ›²ç‡)', data: terrain, backgroundColor: 'rgba(44, 62, 80, 0.6)', fill: true, pointRadius: 0 }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}
</script>
</body>
</html>