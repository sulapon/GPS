<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>GPS é€šè¨Šå‰–é¢åˆ†æå„€ (GitHub ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/geotiff"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        #log { background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 13px; height: 120px; overflow-y: auto; margin-top: 15px; }
        .input-box { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; margin-bottom: 20px; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #218838; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“¡ é€šè¨Šå®‰å…¨è·é›¢å‰–é¢åˆ†æ (94km ä¿®æ­£ç‰ˆ)</h2>
    <div class="input-box">
        <input type="text" id="posA" value="25.214458, 121.563209" placeholder="Aé» (Lat, Lon)">
        <input type="text" id="posB" value="24.499911, 121.087641" placeholder="Bé» (Lat, Lon)">
        <input type="number" id="freq" value="2400" placeholder="é »ç‡ MHz">
        <button onclick="analyze()">é–‹å§‹åˆ†æ</button>
    </div>
    <div id="log">ç­‰å¾…æ“ä½œ... (æª”æ¡ˆéœ€å‘½åç‚º taiwan_dsm_wgs84_cog.tif)</div>
    <div style="height: 450px; margin-top: 20px;">
        <canvas id="profileChart"></canvas>
    </div>
</div>

<script>
async function analyze() {
    const log = document.getElementById('log');
    const tifUrl = "taiwan_dsm_wgs84_cog.tif"; // ç¢ºä¿æª”åå¤§å°å¯«å®Œå…¨ä¸€è‡´
    log.innerHTML = `â³ æ­£åœ¨é€£ç·šè‡³é›²ç«¯æ•¸æ“šæº...<br>`;

    try {
        // 1. æ”¹ç”¨ fromUrl è®€å– GitHub ä¸Šçš„æª”æ¡ˆ
        const tiff = await GeoTIFF.fromUrl(tifUrl);
        const image = await tiff.getImage();
        const bbox = image.getBoundingBox();
        const [w, h] = [image.getWidth(), image.getHeight()];

        // 2. å–å¾—è¼¸å…¥åº§æ¨™èˆ‡é »ç‡
        const pA = document.getElementById('posA').value.split(',').map(v => parseFloat(v.trim()));
        const pB = document.getElementById('posB').value.split(',').map(v => parseFloat(v.trim()));
        const freq = parseFloat(document.getElementById('freq').value);
        const antH = 5; // å‡è¨­å¤©ç·šæ¶é«˜ 5 ç±³

        // 3. è¨ˆç®—ç¸½è·é›¢ (Haversine ç®—å¤§åœ“è·é›¢)
        const R_earth = 6371; 
        const dLat = (pB[0]-pA[0]) * Math.PI/180;
        const dLon = (pB[1]-pA[1]) * Math.PI/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(pA[0]*Math.PI/180) * Math.cos(pB[0]*Math.PI/180) * Math.sin(dLon/2)**2;
        const totalDist = 2 * R_earth * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); // km

        log.innerHTML += `âœ… æˆåŠŸè¼‰å…¥ TIFï¼ç¸½è·é›¢ï¼š${totalDist.toFixed(2)} km<br>`;

        const samples = 150;
        let terrainData = [], losData = [], fresnelData = [], labels = [];

        for (let i = 0; i <= samples; i++) {
            const r = i / samples;
            const lat = pA[0] + (pB[0] - pA[0]) * r;
            const lon = pA[1] + (pB[1] - pA[1]) * r;

            // åº§æ¨™å°ä½ (ä¹‹å‰å·²è§£æ±ºåç§»)
            const x = Math.max(0, Math.min(w - 1, ((lon - bbox[0]) / (bbox[2] - bbox[0])) * w));
            const y = Math.max(0, Math.min(h - 1, ((bbox[3] - lat) / (bbox[3] - bbox[1])) * h));

            const raster = await image.readRasters({ window: [Math.floor(x), Math.floor(y), Math.floor(x) + 1, Math.floor(y) + 1] });
            const baseElev = raster[0][0] > -500 ? raster[0][0] : 0;

            // 4. åœ°çƒæ›²ç‡ä¿®æ­£ï¼šåœ¨ä¸­æ®µé«˜åº¦æœƒå¢åŠ  (d1 * d2) / 12.742
            const d1 = totalDist * r;
            const d2 = totalDist * (1 - r);
            const curvature = (d1 * d2 * 1000) / 12742; // å…¬å°º

            // 5. ç¬¬ä¸€è²»æ¶…çˆ¾å€åŠå¾‘ (60% æ¸…ç©ºå€)
            const f1 = 17.32 * Math.sqrt((d1 * d2) / ((freq/1000) * totalDist));

            terrainData.push(baseElev + curvature);
            labels.push(d1.toFixed(1));
            fresnelData.push(f1);
        }

        // å»ºç«‹è¦–è·ç·š (LoS)
        const startH = terrainData[0] + antH;
        const endH = terrainData[samples] + antH;
        for (let i = 0; i <= samples; i++) {
            const r = i / samples;
            const line = startH + (endH - startH) * r;
            losData.push(line);
            fresnelData[i] = line - (fresnelData[i] * 0.6); // æ¸›å» 60% F1 åŠå¾‘
        }

        renderChart(labels, terrainData, losData, fresnelData);
        log.innerHTML += `âœ¨ åˆ†æå®Œç•¢ã€‚ç´…è‰²è™›ç·šç‚º 60% è²»æ¶…çˆ¾å®‰å…¨å€ã€‚`;

    } catch (err) {
        log.innerHTML = `<span style="color:red">âŒ è®€å–å¤±æ•—ï¼š${err.message}</span><br>æç¤ºï¼šè«‹æª¢æŸ¥æª”æ¡ˆæ˜¯å¦è¢« Git LFS é–å®šï¼Œæˆ–æª”åæ˜¯å¦æ­£ç¢ºã€‚`;
    }
}

function renderChart(labels, terrain, los, fresnel) {
    const ctx = document.getElementById('profileChart').getContext('2d');
    if (window.myChart) window.myChart.destroy();
    window.myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                { label: 'è¦–è· (LoS)', data: los, borderColor: '#f1c40f', pointRadius: 0, fill: false },
                { label: '60% è²»æ¶…çˆ¾å®‰å…¨ç·š', data: fresnel, borderColor: '#e74c3c', borderDash: [5, 5], pointRadius: 0, fill: false },
                { label: 'ä¿®æ­£åœ°å½¢ (å«æ›²ç‡)', data: terrain, backgroundColor: 'rgba(52, 73, 94, 0.6)', fill: true, pointRadius: 0 }
            ]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            scales: { x: { title: { display: true, text: 'è·é›¢ (km)' } }, y: { title: { display: true, text: 'æµ·æ‹” (m)' } } }
        }
    });
}
</script>
</body>
</html>