<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>DSM 地形剖面遮蔽分析儀</title>
    <script src="https://cdn.jsdelivr.net/npm/geotiff"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; max-width: 1000px; margin: auto; padding: 20px; background: #f4f7f6; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .input-row { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .input-group { flex: 1; min-width: 200px; }
        input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background: #0056b3; }
        #status { margin-top: 15px; color: #666; font-weight: bold; text-align: center; }
        canvas { background: white; margin-top: 20px; border-radius: 8px; }
    </style>
</head>
<body>

<div class="card">
    <h2>⛰️ 地形剖面遮蔽分析 (DSM)</h2>
    
    <div class="input-row">
        <div class="input-group">
            <label>A 點座標 (Lat, Lon):</label>
            <input type="text" id="p1" value="25.214458, 121.563209">
        </div>
        <div class="input-group">
            <label>A 點天線高 (m):</label>
            <input type="number" id="h1" value="3">
        </div>
    </div>

    <div class="input-row">
        <div class="input-group">
            <label>B 點座標 (Lat, Lon):</label>
            <input type="text" id="p2" value="24.499911, 121.087641">
        </div>
        <div class="input-group">
            <label>B 點天線高 (m):</label>
            <input type="number" id="h2" value="3">
        </div>
    </div>

    <div class="input-row">
        <div class="input-group">
            <label>TIF 檔案名稱或路徑:</label>
            <input type="text" id="tifUrl" value="taiwan_dsm_wgs84_cog.tif">
        </div>
    </div>

    <button onclick="runAnalysis()">開始生成剖面圖</button>
    <div id="status">準備就緒，點擊按鈕開始分析</div>
</div>

<div style="height: 500px;">
    <canvas id="profileChart"></canvas>
</div>

<script>
let chart;

async function runAnalysis() {
    const tifPath = document.getElementById('tifUrl').value;
    const h1 = parseFloat(document.getElementById('h1').value);
    const h2 = parseFloat(document.getElementById('h2').value);
    const status = document.getElementById('status');

    try {
        status.innerText = "⏳ 正在讀取 TIF 數據...";
        
        // 讀取 GeoTIFF
        const tiff = await GeoTIFF.fromUrl(tifPath);
        const image = await tiff.getImage();
        const bbox = image.getBoundingBox(); 
        const [w, h] = [image.getWidth(), image.getHeight()];

        // 解析座標 (注意：使用者輸入通常是 Lat, Lon，TIF 需要 Lon, Lat)
        const coord1 = document.getElementById('p1').value.split(',').map(n => parseFloat(n.trim()));
        const coord2 = document.getElementById('p2').value.split(',').map(n => parseFloat(n.trim()));
        
        const lat1 = coord1[0], lon1 = coord1[1];
        const lat2 = coord2[0], lon2 = coord2[1];

        const samples = 100;
        let elevData = [];
        let labels = [];
        let losLine = [];

        for (let i = 0; i <= samples; i++) {
            const ratio = i / samples;
            const curLat = lat1 + (lat2 - lat1) * ratio;
            const curLon = lon1 + (lon2 - lon1) * ratio;

            // 經緯度轉像素
            const x = Math.floor(((curLon - bbox[0]) / (bbox[2] - bbox[0])) * w);
            const y = Math.floor(((bbox[3] - curLat) / (bbox[3] - bbox[1])) * h);

            // 讀取該點高度
            const raster = await image.readRasters({ window: [x, y, x + 1, y + 1] });
            const groundEle = raster[0][0];
            elevData.push(groundEle);
            labels.push(i === 0 ? "A 點" : i === samples ? "B 點" : "");
        }

        // 計算直視線 (LOS)
        const startTotalEle = elevData[0] + h1;
        const endTotalEle = elevData[samples] + h2;

        for (let i = 0; i <= samples; i++) {
            const ratio = i / samples;
            losLine.push(startTotalEle + (endTotalEle - startTotalEle) * ratio);
        }

        renderChart(labels, elevData, losLine);
        status.innerText = "✅ 分析完成！橘線為視距，咖啡色為地形。";

    } catch (e) {
        status.innerText = "❌ 錯誤: " + e.message + " (請確認 TIF 檔案在正確位置)";
        console.error(e);
    }
}

function renderChart(labels, terrain, los) {
    const ctx = document.getElementById('profileChart').getContext('2d');
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '直視訊號 (LOS)',
                    data: los,
                    borderColor: '#FF8C00',
                    borderWidth: 3,
                    fill: false,
                    pointRadius: 0
                },
                {
                    label: '地形高程 (DSM)',
                    data: terrain,
                    backgroundColor: 'rgba(139, 69, 19, 0.5)',
                    borderColor: '#5D4037',
                    fill: true,
                    pointRadius: 0,
                    stepped: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { title: { display: true, text: '海拔高度 (m)' }, beginAtZero: false },
                x: { ticks: { autoSkip: false } }
            },
            plugins: {
                legend: { position: 'top' }
            }
        }
    });
}
</script>
</body>
</html>