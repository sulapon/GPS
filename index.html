<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>DSM é®è”½å‰–é¢åˆ†æå„€</title>
    <script src="https://cdn.jsdelivr.net/npm/geotiff"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: auto; padding: 20px; background: #f0f2f5; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #status { margin-top:10px; padding: 10px; border-radius: 5px; background: #eee; min-height: 20px; }
        .error { color: #d9534f; background: #f2dede !important; }
    </style>
</head>
<body>
    <div class="card">
        <h2>â›°ï¸ å…©é»é®è”½å‰–é¢åˆ†æ (3m å¤©ç·š)</h2>
        <p>Aé»: 25.214458, 121.563209 | Bé»: 24.499911, 121.087641</p>
        <button id="btn" onclick="analyze()" style="padding: 10px 20px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px;">
            ğŸš€ é–‹å§‹åˆ†æ
        </button>
        <div id="status">æº–å‚™å°±ç·’ï¼Œè«‹é»æ“ŠæŒ‰éˆ•</div>
    </div>
    <div style="height:400px; margin-top:20px;">
        <canvas id="profileChart"></canvas>
    </div>

<script>
async function analyze() {
    const status = document.getElementById('status');
    const btn = document.getElementById('btn');
    status.classList.remove('error');
    status.innerText = "â³ æ­£åœ¨è®€å– TIF æ¨™é ­æ•¸æ“š...";
    btn.disabled = true;

    // é€™è£¡æˆ‘å€‘ç›´æ¥ç”¨ç›¸å°è·¯å¾‘ï¼ŒGitHub Pages ä¸‹é€™æœ€ç©©å®š
    const tifUrl = "taiwan_dsm_wgs84_cog.tif";

    try {
        // 1. åˆå§‹åŒ– GeoTIFF
        const tiff = await GeoTIFF.fromUrl(tifUrl, { allowFullFile: false });
        const image = await tiff.getImage();
        const bbox = image.getBoundingBox(); 
        const [w, h] = [image.getWidth(), image.getHeight()];

        const p1 = [25.214458, 121.563209]; // Lat, Lon
        const p2 = [24.499911, 121.087641];
        
        let elevData = [], losLine = [], labels = [];
        const samples = 100;

        status.innerText = `â³ æ­£åœ¨æ¡æ¨£åœ°å½¢å‰–é¢ (0/100)...`;

        for (let i = 0; i <= samples; i++) {
            const r = i / samples;
            const lat = p1[0] + (p2[0] - p1[0]) * r;
            const lon = p1[1] + (p2[1] - p1[1]) * r;

            // ç¶“ç·¯åº¦åº§æ¨™è½‰ç‚ºå½±åƒåƒç´ åº§æ¨™
            const x = Math.floor(((lon - bbox[0]) / (bbox[2] - bbox[0])) * w);
            const y = Math.floor(((bbox[3] - lat) / (bbox[3] - bbox[1])) * h);

            // è®€å–è©²åƒç´ çš„é«˜ç¨‹æ•¸æ“š
            const raster = await image.readRasters({ window: [x, y, x + 1, y + 1] });
            elevData.push(raster[0][0]);
            labels.push(i % 10 === 0 ? `${(i/samples*100).toFixed(0)}%` : "");
        }

        // è¨ˆç®—è¦–è·ç·š (èµ·é»èˆ‡çµ‚é»å„åŠ  3 ç±³å¤©ç·šé«˜)
        const startH = elevData[0] + 3;
        const endH = elevData[samples] + 3;
        let blocked = false;

        for (let i = 0; i <= samples; i++) {
            const losH = startH + (endH - startH) * (i/samples);
            losLine.push(losH);
            if(elevData[i] > losH) blocked = true;
        }

        renderChart(labels, elevData, losLine);
        status.innerHTML = `âœ… åˆ†æå®Œæˆï¼çµæœï¼š<strong>${blocked ? "âŒ ç™¼ç¾åœ°å½¢é®è”½" : "âœ… è¦–ç·šè‰¯å¥½"}</strong>`;
    } catch (err) {
        status.classList.add('error');
        status.innerText = "âŒ ç™¼ç”ŸéŒ¯èª¤: " + err.message + "\nè«‹ç¢ºèª TIF æª”æ¡ˆèˆ‡ HTML æ˜¯å¦åœ¨åŒä¸€è³‡æ–™å¤¾ä¸”åç¨±æ­£ç¢ºã€‚";
        console.error(err);
    }
    btn.disabled = false;
}

function renderChart(labels, terrain, los) {
    const ctx = document.getElementById('profileChart').getContext('2d');
    if(window.myChart) window.myChart.destroy();
    window.myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                { label: '3m è¦–è·ç·š (LOS)', data: los, borderColor: '#ff9800', borderWidth: 2, pointRadius: 0, fill: false },
                { label: 'åœ°å½¢å‰–é¢ (DSM)', data: terrain, backgroundColor: 'rgba(139, 69, 19, 0.4)', borderColor: '#5d4037', fill: true, pointRadius: 0 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { title: { display: true, text: 'é«˜åº¦ (m)' } }
            }
        }
    });
}
</script>
</body>
</html>