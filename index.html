<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å®‰å…¨é€šè¨Šè·é›¢åˆ†æå„€ (Fresnel Radius)</title>
    <script src="https://cdn.jsdelivr.net/npm/geotiff"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: system-ui; background: #f4f7f6; padding: 20px; }
        .card { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .inputs { display: flex; gap: 10px; margin-bottom: 15px; }
        input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        button { padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        #status { font-size: 13px; color: #666; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ“¡ å®‰å…¨é€šè¨Šè·é›¢è¨ˆç®—æ©Ÿ (COG æ”¯æ´ç‰ˆ)</h2>
    <div class="inputs">
        <input type="text" id="pA" value="25.214, 121.563" placeholder="Aé»åº§æ¨™">
        <input type="text" id="pB" value="24.499, 121.087" placeholder="Bé»åº§æ¨™">
        <input type="number" id="freq" value="2400" placeholder="é »ç‡ (MHz)">
        <button onclick="analyze()">é–‹å§‹åˆ†æ</button>
    </div>
    <div id="status">æº–å‚™å°±ç·’ã€‚ç¢ºèªæª”æ¡ˆç‚º taiwan_dsm_wgs84_cog.tif</div>
    <div style="height: 400px;"><canvas id="myChart"></canvas></div>
</div>

<script>
async function analyze() {
    const status = document.getElementById('status');
    const url = "taiwan_dsm_wgs84_cog.tif"; // ç›´æ¥è®€å–åŒç›®éŒ„ä¸‹çš„ COG
    
    try {
        status.innerText = "ğŸ” æ­£åœ¨é€é COG è®€å–ç‰¹å®šé«˜åº¦æ•¸æ“š...";
        const tiff = await GeoTIFF.fromUrl(url); // é—œéµï¼šgeotiff.js æœƒè‡ªå‹•ç™¼é€ Range Request
        const image = await tiff.getImage();
        const bbox = image.getBoundingBox();
        const [w, h] = [image.getWidth(), image.getHeight()];

        // åƒæ•¸è§£æ
        const coordA = document.getElementById('pA').value.split(',').map(n => parseFloat(n));
        const coordB = document.getElementById('pB').value.split(',').map(n => parseFloat(n));
        const fMHz = parseFloat(document.getElementById('freq').value);
        const distKM = Math.sqrt(Math.pow(coordA[0]-coordB[0],2) + Math.pow(coordA[1]-coordB[1],2)) * 111;

        let data_terrain = [], data_los = [], data_safety = [], labels = [];
        const steps = 100;

        for (let i = 0; i <= steps; i++) {
            const ratio = i / steps;
            const lat = coordA[0] + (coordB[0] - coordA[0]) * ratio;
            const lon = coordA[1] + (coordB[1] - coordA[1]) * ratio;

            // å¾ COG è®€å–è©²é»åƒç´ 
            const x = ((lon - bbox[0]) / (bbox[2] - bbox[0])) * w;
            const y = ((bbox[3] - lat) / (bbox[3] - bbox[1])) * h;
            const pixel = await image.readRasters({ window: [Math.floor(x), Math.floor(y), Math.floor(x)+1, Math.floor(y)+1] });
            const height = pixel[0][0] > -500 ? pixel[0][0] : 0;

            // è¨ˆç®—è²»æ¶…çˆ¾åŠå¾‘ (Fresnel Radius)
            const d1 = distKM * ratio;
            const d2 = distKM * (1 - ratio);
            const fresnel = 17.32 * Math.sqrt((d1 * d2) / ((fMHz/1000) * distKM));
            
            // åœ°çƒæ›²ç‡
            const drop = (d1 * d2 * 1000) / 12.742;

            data_terrain.push(height + drop);
            labels.push(d1.toFixed(1));
            data_safety.push(fresnel);
        }

        // è¦–è·ç·š (å‡è¨­å¤©ç·šé«˜ 5m)
        const lineStart = data_terrain[0] + 5;
        const lineEnd = data_terrain[steps] + 5;
        const finalSafety = data_terrain.map((t, i) => {
            const line = lineStart + (lineEnd - lineStart) * (i/steps);
            data_los.push(line);
            return line - (data_safety[i] * 0.6); // 60% å®‰å…¨å€åŸŸ
        });

        render(labels, data_terrain, data_los, finalSafety);
        status.innerText = `âœ… åˆ†æå®Œæˆï¼è·é›¢ï¼š${distKM.toFixed(2)} km`;
    } catch (e) {
        status.innerText = "âŒ éŒ¯èª¤ï¼š" + e.message;
    }
}

function render(labels, terrain, los, safety) {
    const ctx = document.getElementById('myChart').getContext('2d');
    if (window.chartInst) window.chartInst.destroy();
    window.chartInst = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                { label: 'åœ°å½¢å‰–é¢', data: terrain, backgroundColor: 'rgba(0,0,0,0.3)', fill: true, pointRadius: 0 },
                { label: 'è¦–è·ç·š', data: los, borderColor: 'orange', fill: false, pointRadius: 0 },
                { label: '60% è²»æ¶…çˆ¾å®‰å…¨ç·š', data: safety, borderColor: 'red', borderDash: [5,5], fill: false, pointRadius: 0 }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}
</script>
</body>
</html>